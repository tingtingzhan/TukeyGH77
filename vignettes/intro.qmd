---
title: "Tukey"
author: Tingting Zhan
format: 
  html:
    page-layout: full
    html-math-method: katex
toc: true
toc-location: left
toc-depth: 4
toc-title: ''
editor: visual
vignette: >
  %\VignetteIndexEntry{intro}
  %\VignetteEngine{quarto::html}
  %\VignetteEncoding{UTF-8}
---

# Introduction

This vignette of package **`TukeyGH77`** ([CRAN](https://CRAN.R-project.org/package=TukeyGH77), [Github](https://github.com/tingtingzhan/TukeyGH77)) documents ..

## Note to Users

Examples in this vignette require that the `search` path has

```{r}
library(TukeyGH77)
```

```{r}
#| echo: false
library(knitr) # for tables in this vignette
op = par(no.readonly = TRUE)
#options(mc.cores = 1L) # for CRAN submission
```

## Terms and Abbreviations

```{r}
#| echo: false
#| results: asis
c(
  '', 'Forward [pipe operator](https://search.r-project.org/R/refmans/base/html/pipeOp.html) introduced in `R` 4.1.0', 
  '[`all.equal.numeric`](https://search.r-project.org/R/refmans/base/html/all.equal.html)', 'Test of near equality',
  '`CRAN`, `R`', '[The Comprehensive R Archive Network](https://cran.r-project.org)',
  '[`curve`](https://search.r-project.org/R/refmans/graphics/html/curve.html)', 'Function plots',
  '[`mad`](https://search.r-project.org/R/refmans/stats/html/mad.html)', 'Median Absolute Deviation',
  '[`median`](https://search.r-project.org/R/refmans/stats/html/median.html)', 'Median',
  '[`search`](https://search.r-project.org/R/refmans/base/html/search.html)', 'Search path'
) |>
  matrix(nrow = 2L, dimnames = list(c('Term / Abbreviation', 'Description'), NULL)) |>
  t.default() |>
  as.data.frame.matrix() |> 
  kable() 
```

# Tukey's $g$-&-$h$ Transformation

## Tukey's Transformation

Tukey's $g$-&-$h$ random variable $t_{gh}$ \citep{Tukey77} is a monotone transformation of the standard normal variable $z$ \cite{Hoaglin85}, $$
t_{gh} =
\begin{cases}
z\cdot G_g(z) & g\neq 0,\ g\text{-distribution} \\
z\cdot H_h(z) & h>0,\ h\text{-distribution} \\
z\cdot G_g(z)\cdot H_h(z) & g\neq 0,h>0,\ gh\text{-distribution} \\
\end{cases}
$$ with skewness

$$
G_g(z)=
\begin{cases}
(e^{gz}-1)/gz & g\neq 0\\\
\displaystyle\lim_{g\rightarrow 0} G_{g \ne 0}(z)=1 & g=0
\end{cases}
$$ and kurtosis

$$
H_h(z)=
\begin{cases}
e^{hz^2/2} & h>0\\
1 & h =0
\end{cases}
$$ Tukey's transformation function `z2gh()` transforms the standard normal variable $z$ to Tukey's $g$-&-$h$ random variable $t_{gh}$.

```{r}
set.seed(15); rnorm(1e3L) |>
  z2gh(g = .5, h = .1) |>
  hist(breaks = 30L, xlab = NULL, main = c('Tukey(g=.5, h=.1)'))
```

## Inverse Tukey's Transformation

Inverse Tukey's transformation $\zeta_{gh}$

$$
\zeta_{gh}(t) =
\begin{cases}
g^{-1}\ln(gt+1), & g\neq0 \\
z:\ z\cdot H_h(z) = t, & h>0 \\
z:\ z\cdot G_g(z)\cdot H_h(z) = t, & g\neq 0,\ h>0 
\end{cases}
$$ does not have a closed analytical form when $h>0$, but the numerical solution could be found by using a root-finding algorithm \citep{Brent71}.

Inverse Tukey's transformation function `gh2z()` transforms the Tukey's $g$-&-$h$ random variable $t_{gh}$ to standard normal variable $z$. A closed analytical form of $\zeta_{gh}$ exists when $h=0$, thus the discrepancy is merely a floating-point error.

```{r}
set.seed(24); x = rnorm(1e3L)
x |> 
  z2gh(g = .3, h = 0) |> 
  gh2z(g = .3, h = 0) |> 
  all.equal.numeric(target = x, tolerance = .Machine$double.eps)
```

We have to rely on a root-finding algorithm when $h>0$. To find a numerical solution for standard normal quantile $z$, we need only to search the interval of $(-8.3, 8.3)$, as

```{r}
stopifnot(identical(pnorm(8.3), 1))
```

Nonetheless, the root-finding algorithm would have much larger discrepancy (which can be controlled by parameter `tol` inside function `gh2z()`).

```{r}
set.seed(91); x = rnorm(1e3L)
x |> 
  z2gh(g = 0, h = .1) |> 
  gh2z(g = 0, h = .1) |> 
  all.equal.numeric(target = x, tolerance = .Machine$double.eps)
```

```{r}
set.seed(56); x = rnorm(1e3L)
x |> 
  z2gh(g = .3, h = .1) |> 
  gh2z(g = .3, h = .1) |> 
  all.equal.numeric(target = x, tolerance = .Machine$double.eps)
```

# Tukey $g$-and-$h$ Distribution

## Probability

The distribution function is $F_{gh}(t)=\text{Pr}(T_{gh} \le t)=\text{Pr}\left(Z \le \zeta_{gh}(t)\right)$.

```{r}
curve(pGH(x, g = .3, h = .1), from = -2.5, to = 3.5, n = 501L, ylab = 'Probability')
```

## Density

Density function $f_{gh}$ has a closed analytical form in terms of $\zeta_{gh}$,

$$
f_{gh}(t) = \dfrac{e^{-z^2/2}}{\sqrt{2\pi}\cdot\partial t_{gh}/\partial z}\Bigg|_{z=\zeta_{gh}(t)}
$$

where

$$
\dfrac{\partial t_{gh}}{\partial z}=
\begin{cases}
e^{gz}, & g\neq0\\
e^{hz^2/2}(1+hz^2), & h>0 \\
e^{hz^2/2}\left(e^{gz}+g^{-1}hz(e^{gz}-1)\right), & g\neq 0,\ h>0 
\end{cases}
$$

Note that when $h=0$, domain has a bound.

```{r}
curve(dGH(x, g = 1, h = 0), from = -1.2, to = 3.5, n = 501L, ylab = 'Density')
```

When $h>0$, domain is $(-\infty, \infty)$.

```{r}
curve(dGH(x, g = .3, h = .1), from = -2.5, to = 3.5, n = 501L, ylab = 'Density')
```

## Quantile

```{r}
curve(qGH(x, g = .3, h = .1), from = 0, to = 1, n = 501L, ylab = 'Quantile')
```

## Simulation

```{r}
rGH(n = 1e3L, g = .3, h = .1) |> 
  hist(xlab = 'TukeyGH(g = .3, h = .1)', main = NULL)
```

# Letter-Value Based Estimates (@Hoaglin85)

Consider a random sample $T$ from Tukey's $g$-&-$h$ distribution with parameters $(A,B,g,h)$. The location parameter estimate $\hat{A}$ is simply the sample `median`, thus we subtract the sample median from the original sample, and focus on the estimation of $(B, g, h)$.

Let $\hat{t}_p$ be the $p$-th sample quantile, for $0<p<.5$. Note that we have enforced that $\hat{t}_{.5}=0$.  

We refer $t_p$ as the lower half-spread (LHS) and $t_{1-p}$ as the upper half-spread (UHS). 


## Normal Model

Under the assumption that $g=h=0$, the scale parameter estiamte $\hat{B}$ is simply the sample mean absolute deviation (`mad`).

```{r}
set.seed(14); rnorm(1e3L) |>
  letterValue(g_ = FALSE, h_ = FALSE)
```

## Tukey's $h$-Model

From Tukey's $h$-transformation (i.e., $g=0$) on LHS and UHS, as well as their difference,

$$
\begin{cases}
t_p = B~z_p~e^{hz^2_p/2} & \Rightarrow\quad 
\ln\left(\dfrac{\hat{t}_p}{z_p}\right) = \ln B+h\cdot z^2_p/2 + \varepsilon\\
t_{1-p} = B~z_{1-p}~e^{hz^2_{1-p}/2} & \Rightarrow\quad \ln\left(\dfrac{\hat{t}_{1-p}}{-z_p}\right) = \ln B+h\cdot z^2_p/2 + \varepsilon\\
t_{1-p}-t_p = B(z_{1-p}-z_p)e^{hz^2_p/2} & \Rightarrow\quad \ln\left(\dfrac{\hat{t}_{1-p} - \hat{t}_p}{-2z_p}\right) = \ln B + h\cdot z^2_p/2 + \varepsilon
\end{cases}
$$

We may perform any of these three least squares regressions and let $(\ln\hat{B}, \hat{h})$ be the estimated intercept and slope parameters (@Hoaglin85, equations (26a), (26b), (27) and (28)).

```{r}
#| fig-height: 4
#| fig-width: 4
set.seed(63); rGH(1e3L, h = .2) |>
  letterValue(g_ = FALSE)
```



## Tukey's $g$-Model

From Tukey's $g$-transformation (i.e., $h=0$) on LHS and UHS, as well as their ratio,

$$
\begin{cases}
t_p = B(e^{gz_p}-1)/g\\
t_{1-p} = B(e^{gz_{1-p}}-1)/g\\
\dfrac{t_{1-p}}{-t_p} = \dfrac{e^{-gz_p}-1}{1-e^{gz_p}} = e^{-gz_p} & \Rightarrow\quad g = -\dfrac{1}{z_{p}}\cdot \ln\left(\dfrac{t_{1-p}}{-t_{p}}\right)
\end{cases}
$$
Let

$$
\hat{g}_p = -\dfrac{1}{z_{p}}\cdot \ln\left(\dfrac{\hat{t}_{1-p}}{-\hat{t}_{p}}\right)
$$
The skewness parameter estimate $\hat{g}$ is the `median` of $\hat{g}_p$ (@Hoaglin85, equation (10)).  


Let $\hat{B}$ be the slope estimate of either or both of these two least squares regression with a fixed-zero intercept term (@Hoaglin85, equations (8a) and (8b)).

$$
\begin{cases}
\hat{t}_p = 0 + B\cdot (e^{\hat{g}z_p}-1)/\hat{g} + \varepsilon\\
\hat{t}_{1-p} = 0 + B\cdot (e^{\hat{g}z_{1-p}}-1)/\hat{g} + \varepsilon
\end{cases}
$$


```{r}
#| fig-height: 4
set.seed(43); rGH(1e3L, g = .3) |>
  letterValue(h_ = FALSE)
```



## Tukey's $g$-&-$h$ Model

From Tukey's $g$-&-$h$ transformation on LHS and UHS, as well as their difference and ratio,

$$
\begin{cases}
t_p = Bg^{-1}(e^{gz_p}-1)e^{hz^2_p/2}\\
t_{1-p} = Bg^{-1}(e^{gz_{1-p}}-1)e^{hz^2_{1-p}/2}\\
t_{1-p}-t_p = Bg^{-1}(e^{-gz_p}-e^{gz_p})e^{hz^2_p/2}\\
\dfrac{t_{1-p}}{-t_p} = \dfrac{e^{-gz_p}-1}{1-e^{gz_p}} = e^{-gz_p}\\
\end{cases}
$$

Similar to Tukey's $g$-model, the skewness parameter estimate $\hat{g}$ is the `median` of $\hat{g}_p$ (@Hoaglin85, equation (31)). 

Let $(\ln\hat{B}, \hat{h})$ be the estimated intercept and slope parameters of either of these three least squares regression models and 

$$
\begin{cases}
\ln\left(\dfrac{\hat{g}t_p}{e^{\hat{g}z_p}-1}\right) = \ln B+h\cdot z^2_p/2 + \varepsilon\\
\ln\left(\dfrac{\hat{g}t_{1-p}}{e^{-\hat{g}z_p}-1}\right) = \ln B+h\cdot z^2_p/2 + \varepsilon\\
\ln\left(\dfrac{\hat{g}(t_{1-p}-t_p)}{e^{-\hat{g}z_p}-e^{\hat{g}z_p}}\right) = \ln B + h\cdot z^2_p/2 + \varepsilon
\end{cases}
$$

Note that these three least squares regression models are very sensitive to the skewness parameter estimate $\hat{g}$.  At a smaller sample size, an inaccurate $\hat{g}$ may result in negative slope(s) for $\hat{h}$. In such case we let $\hat{h}=0$.

```{r}
#| fig-height: 4
set.seed(72); rGH(n = 1e4L, A = .5, g = -.3, h = .1) |> # large `n` to ensure accurate \hat{g}
  letterValue()
```







